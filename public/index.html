<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SaluMedX Modular</title>
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <style>
    :root { --bg:#f5f7fb; --card:#ffffff; --text:#1f2937; --muted:#6b7280; --primary:#5b7cff; --primary-2:#7c3aed; --border:#e5e7eb; --success:#28a745; --danger:#dc3545; }
    .dark { --bg:#0f172a; --card:#111827; --text:#e5e7eb; --muted:#9ca3af; --primary:#8b5cf6; --primary-2:#22d3ee; --border:#1f2937; --success:#22c55e; --danger:#f87171; }
    body { font-family:'Segoe UI', Tahoma, sans-serif; background:var(--bg); color:var(--text); min-height:100vh; margin:0; padding:24px; display:flex; justify-content:center; }
    #app { width:100%; max-width:1300px; }
    .layout { display:grid; grid-template-columns:240px 1fr; gap:20px; }
    @media (max-width:900px){ .layout{ grid-template-columns:1fr; } }
    .overlay { position:fixed; inset:0; background:rgba(0,0,0,.25); display:none; align-items:center; justify-content:center; z-index:1000; }
    .overlay.show { display:flex; }
    .spinner { width:56px; height:56px; border-radius:50%; border:5px solid rgba(255,255,255,.4); border-top-color:#fff; animation: spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>
<body>
  <div id="app" :class="{ dark: isDark }">
    <div v-if="currentView==='panel'" class="layout">
      <sidebar-comp></sidebar-comp>
      <main-comp></main-comp>
    </div>
    <div v-else>
      <main-comp></main-comp>
    </div>
    <footer-comp></footer-comp>
    <div class="overlay" :class="{ show: loading }" aria-live="assertive" aria-busy="true">
      <div class="spinner" role="progressbar" aria-label="Cargando"></div>
    </div>
  </div>
  <script>
    const componentPaths = { header:'components/header.html', sidebar:'components/sidebar.html', main:'components/main.html', footer:'components/footer.html' };
    Promise.all(Object.values(componentPaths).map(p => fetch(p).then(r => r.text()))).then(([headerTpl, sidebarTpl, mainTpl, footerTpl]) => {
      const { createApp } = Vue;
      const app = createApp({
        data(){ return { currentView:'login', activeTab:'recetas', loading:false, error:null, success:null, username:'', authToken:null, refreshToken:null, loginForm:{username:'',password:''}, registerForm:{username:'',email:'',password:'',password2:''}, pdfForm:{ paciente:{ nombre:'Cesar', cedula:'1122334455' }, medico:{ nombre:'Abigail', licencia:'987654321' } }, preciosForm:{ nombre:'Paracetamol', lat:-0.21, lng:-78.49, radioKm:5 }, respuesta:null, API_URL:'https://salumedx-rest.onrender.com', GRAPHQL_URL:'http://localhost:4000/graphql', isDark:false, debugMode:false }; },
        mounted(){ this.loadApiUrl(); this.loadAuthToken(); this.checkAuth(); this.isDark = localStorage.getItem('DARK_MODE')==='1'; },
        methods:{ clearMessages(){ this.error=null; this.success=null; }, toggleDark(){ this.isDark=!this.isDark; localStorage.setItem('DARK_MODE', this.isDark?'1':'0'); }, toggleDebug(){ this.debugMode=!this.debugMode; }, loadApiUrl(){ const s=localStorage.getItem('API_URL'); if(s) this.API_URL=s; }, saveApiUrl(){ localStorage.setItem('API_URL', this.API_URL); this.success='URL de API guardada.'; }, loadAuthToken(){ const a=localStorage.getItem('AUTH_TOKEN'); const r=localStorage.getItem('REFRESH_TOKEN'); if(a) this.authToken=a; if(r) this.refreshToken=r; }, saveAuthTokens(a,r){ this.authToken=a||null; this.refreshToken=r||null; a?localStorage.setItem('AUTH_TOKEN',a):localStorage.removeItem('AUTH_TOKEN'); r?localStorage.setItem('REFRESH_TOKEN',r):localStorage.removeItem('REFRESH_TOKEN'); }, async pingApi(){ this.clearMessages(); this.loading=true; try { let res=await axios.get(`${this.API_URL}/`,{withCredentials:true,validateStatus:()=>true,timeout:10000}); if(res.status===404||res.status>=500){ res=await axios.get(`${this.API_URL}/signin/`,{withCredentials:true,validateStatus:()=>true,timeout:10000}); } if([403,401].includes(res.status)){ this.success=`✅ API conectada (${res.status}).`; } else if(res.status===405){ this.success=`✅ API conectada (${res.status}).`; } else if(res.status<400){ this.success=`✅ API responde: ${res.status}`; } else { this.success=`⚠️ API responde: ${res.status}`; } } catch(e){ this.error='❌ No se pudo conectar.'; } finally { this.loading=false; } }, async checkAuth(){ if(!this.authToken) return; try { const r=await axios.get(`${this.API_URL}/tasks/`,{headers:{Authorization:`Bearer ${this.authToken}`},validateStatus:()=>true}); if(r.status<400){ this.currentView='panel'; } else if([401,403].includes(r.status)){ this.saveAuthTokens(null,null); } } catch(e){ } }, async testAuth(){ this.clearMessages(); this.loading=true; try { if(!this.authToken){ this.error='No hay token'; return; } const eps=['/tasks/','/recetas/','/farmacias/']; for(const ep of eps){ const r=await axios.get(`${this.API_URL}${ep}`,{headers:{Authorization:`Bearer ${this.authToken}`},validateStatus:()=>true,timeout:10000}); if(r.status===200){ this.success=`✅ ${ep} OK`; this.currentView='panel'; return; } else if([401,403].includes(r.status)){ this.error=`Auth fallo ${ep}`; return; } } this.error='Ningún endpoint respondió 200'; } finally { this.loading=false; } }, async handleLogin(){ this.clearMessages(); this.loading=true; try { const p={username:this.loginForm.username,email:this.loginForm.username,password:this.loginForm.password}; const r=await axios.post(`${this.API_URL}/signin/`,p,{headers:{'Content-Type':'application/json'},validateStatus:()=>true}); if(r.status>=400) throw new Error(`Error ${r.status}`); const access=r.data?.access; const refresh=r.data?.refresh; if(access) this.saveAuthTokens(access,refresh); this.success='¡Login exitoso!'; this.username=this.loginForm.username; this.currentView='panel'; this.loginForm.password=''; } catch(e){ this.error=e.message||'Error login'; } finally { this.loading=false; } }, async handleRegister(){ this.clearMessages(); if(this.registerForm.password!==this.registerForm.password2){ this.error='Las contraseñas no coinciden'; return; } if(this.registerForm.password.length<8){ this.error='La contraseña debe tener al menos 8 caracteres'; return; } this.loading=true; try { const r=await axios.post(`${this.API_URL}/signup/`,{username:this.registerForm.username,email:this.registerForm.email,password:this.registerForm.password},{headers:{'Content-Type':'application/json'},validateStatus:()=>true}); if(r.status>=400) throw new Error('No se pudo registrar'); this.success='Registro exitoso'; setTimeout(()=>{ this.currentView='login'; this.loginForm.username=this.registerForm.username; this.registerForm={username:'',email:'',password:'',password2:''}; },1500); } catch(e){ this.error=e.message||'Error registro'; } finally { this.loading=false; } }, async handleLogout(){ try { await axios.post(`${this.API_URL}/logout/`,{}, {validateStatus:()=>true}); } catch(_){} this.currentView='login'; this.username=''; this.saveAuthTokens(null,null); this.success='Sesión cerrada'; }, async graphql(q,v={}){ const h={'Content-Type':'application/json'}; if(this.authToken) h.Authorization=`Bearer ${this.authToken}`; const r=await axios.post(this.GRAPHQL_URL,{query:q,variables:v},{headers:h,validateStatus:()=>true}); return r.data; }, async obtenerRecetas(){ this.clearMessages(); this.loading=true; this.respuesta=null; try { const q=`query{ recetas { id fechaEmision pacienteId medicoId observaciones detalles { id productoId cantidad indicaciones } } }`; const r=await this.graphql(q); if(r.errors) this.error=r.errors[0].message; else { this.respuesta=r.data; this.success='Recetas cargadas'; } } catch(e){ this.error='Error recetas'; } finally { this.loading=false; } }, async generarPDF(){ this.clearMessages(); this.loading=true; this.respuesta=null; try { const q=`mutation($pac: PacienteInput!, $med: MedicoInput!){ generarRecetaPdf(paciente:$pac, medico:$med){ mensaje archivo } }`; const vars={ pac:this.pdfForm.paciente, med:this.pdfForm.medico }; const r=await this.graphql(q,vars); if(r.errors) this.error=r.errors[0].message; else { this.respuesta=r.data; this.success='PDF generado'; if(r.data.generarRecetaPdf?.archivo){ const base=this.GRAPHQL_URL.replace('/graphql',''); window.open(base + r.data.generarRecetaPdf.archivo,'_blank'); } } } catch(e){ this.error='Error PDF'; } finally { this.loading=false; } }, async consultarPrecios(){ this.clearMessages(); this.loading=true; this.respuesta=null; try { const q=`query($nombre:String!,$lat:Float!,$lng:Float!,$radioKm:Float!){ preciosMasBaratos(nombre:$nombre,lat:$lat,lng:$lng,radioKm:$radioKm){ farmaciaNombre precio distanciaKm } }`; const r=await this.graphql(q,this.preciosForm); if(r.errors) this.error=r.errors[0].message; else { this.respuesta=r.data; this.success='Precios consultados'; } } catch(e){ this.error='Error precios'; } finally { this.loading=false; } }
        }
      });
      app.component('header-comp', { template: headerTpl });
      app.component('sidebar-comp', { template: sidebarTpl });
      app.component('main-comp', { template: mainTpl });
      app.component('footer-comp', { template: footerTpl });
      app.mount('#app');
    });
  </script>
</body>
</html>