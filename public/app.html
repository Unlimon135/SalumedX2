<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SaluMedX - Sistema de Gesti√≥n</title>
  
  <!-- Vue 3 -->
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  
  <!-- Axios para peticiones HTTP -->
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  
  <style>
    :root {
      --bg: #f5f7fb;
      --card: #ffffff;
      --text: #1f2937;
      --muted: #6b7280;
      --primary: #5b7cff;
      --primary-2: #7c3aed;
      --border: #e5e7eb;
      --success: #28a745;
      --danger: #dc3545;
      --shadow: rgba(0, 0, 0, 0.1);
      --shadow-hover: rgba(0, 0, 0, 0.15);
      --input-bg: #ffffff;
      --response-bg: #f8f9fa;
      --response-border: #dee2e6;
    }
    .dark {
      --bg: #0a0f1e;
      --card: #1a1f35;
      --text: #e2e8f0;
      --muted: #94a3b8;
      --primary: #a78bfa;
      --primary-2: #06b6d4;
      --border: #2d3548;
      --success: #10b981;
      --danger: #f43f5e;
      --shadow: rgba(0, 0, 0, 0.4);
      --shadow-hover: rgba(0, 0, 0, 0.6);
      --input-bg: #0f1729;
      --response-bg: #0f1729;
      --response-border: #2d3548;
    }
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
      transition: background .3s ease, color .3s ease;
    }

    #app {
      width: 100%;
      max-width: 1200px;
    }

    .card {
      background: var(--card);
      border-radius: 12px;
      box-shadow: 0 10px 40px var(--shadow);
      padding: 40px;
      animation: fadeIn 0.5s ease;
      transition: background 0.3s ease, box-shadow 0.3s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    h1 {
      color: var(--text);
      margin-bottom: 30px;
      text-align: center;
      font-size: 2.5em;
      transition: color 0.3s ease;
    }

    h2 {
      color: var(--text);
      margin-bottom: 20px;
      font-size: 1.8em;
      font-weight: 700;
      transition: color 0.3s ease;
    }

    .form-group {
      margin-bottom: 20px;
    }

    label {
      display: block;
      margin-bottom: 8px;
      color: var(--muted);
      font-weight: 600;
      font-size: 14px;
      transition: color 0.3s ease;
    }

    input {
      width: 100%;
      padding: 12px 15px;
      border: 2px solid var(--border);
      background: var(--input-bg);
      color: var(--text);
      border-radius: 8px;
      font-size: 16px;
      transition: all 0.3s ease;
    }
    
    input:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      background: var(--bg);
      color: var(--muted);
    }
    
    input::placeholder {
      color: var(--muted);
      opacity: 0.7;
    }
    
    .dark input::placeholder {
      color: var(--muted);
      opacity: 0.5;
    }

    input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(91, 124, 255, 0.1);
    }
    
    .dark input:focus {
      box-shadow: 0 0 0 3px rgba(167, 139, 250, 0.2);
    }

    .btn {
      padding: 12px 30px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      margin-right: 10px;
      margin-top: 10px;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-2) 100%);
      color: #fff;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(91, 124, 255, 0.4);
    }
    
    .dark .btn-primary:hover {
      box-shadow: 0 8px 20px rgba(167, 139, 250, 0.4);
    }

    .btn-secondary {
      background: #6b7280;
      color: #fff;
      transition: all 0.3s ease;
    }

    .btn-secondary:hover {
      background: #5a6268;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(107, 114, 128, 0.4);
    }
    
    .dark .btn-secondary {
      background: #374151;
      border: 1px solid var(--border);
    }
    
    .dark .btn-secondary:hover {
      background: #4b5563;
      box-shadow: 0 4px 12px rgba(75, 85, 99, 0.4);
    }

    .btn-success {
      background: var(--success);
      color: #fff;
      transition: all 0.3s ease;
    }

    .btn-success:hover:not(:disabled) {
      background: #218838;
      transform: translateY(-2px);
    }
    
    .btn-success:disabled {
      background: #6b7280;
      cursor: not-allowed;
      opacity: 0.5;
      transform: none;
    }

    .btn-danger {
      background: var(--danger);
      color: #fff;
    }

    .btn-danger:hover {
      background: #c82333;
    }

    .alert-error { 
      background: rgba(239,68,68,.12); 
      color: #ef4444; 
      border: 1px solid rgba(239,68,68,.3); 
      padding: 12px 16px;
      border-radius: 8px;
      margin: 10px 0;
      transition: all 0.3s ease;
      font-size: 14px;
      line-height: 1.6;
      white-space: pre-wrap;
      font-weight: 500;
    }
    .dark .alert-error {
      background: rgba(244,63,94,.15);
      color: #fca5a5;
      border-color: rgba(244,63,94,.4);
    }
    
    .alert-success { 
      background: rgba(34,197,94,.12); 
      color: #22c55e; 
      border: 1px solid rgba(34,197,94,.3); 
      padding: 12px 16px;
      border-radius: 8px;
      margin: 10px 0;
      transition: all 0.3s ease;
    }
    .dark .alert-success {
      background: rgba(16,185,129,.15);
      color: #6ee7b7;
      border-color: rgba(16,185,129,.4);
    }
    
    .alert-info { 
      background: rgba(59,130,246,.12); 
      color: #60a5fa; 
      border: 1px solid rgba(59,130,246,.3); 
      padding: 12px 16px;
      border-radius: 8px;
      margin: 10px 0;
      transition: all 0.3s ease;
    }
    .dark .alert-info {
      background: rgba(6,182,212,.15);
      color: #67e8f9;
      border-color: rgba(6,182,212,.4);
    }

    /* Layout Sidebar */
    .layout { display: grid; grid-template-columns: 240px 1fr; gap: 20px; }
    .sidebar { 
      background: var(--card); 
      border: 1px solid var(--border); 
      border-radius: 12px; 
      padding: 16px; 
      height: 100%; 
      align-self: start;
      box-shadow: 0 4px 12px var(--shadow);
      transition: all 0.3s ease;
    }
    .sidebar h3 { 
      margin-bottom: 12px; 
      font-size: 15px; 
      letter-spacing: .5px; 
      color: var(--muted); 
      font-weight: 700;
      text-transform: uppercase;
    }
    .nav-link { 
      display: block; 
      padding: 10px 12px; 
      border-radius: 8px; 
      color: var(--text); 
      text-decoration: none; 
      margin-bottom: 6px; 
      border: 1px solid transparent; 
      font-size: 14px;
      transition: all 0.3s ease;
      font-weight: 500;
    }
    .nav-link.active, .nav-link:hover { 
      border-color: var(--primary); 
      background: rgba(91,124,255,.08); 
      transform: translateX(4px);
    }
    .dark .nav-link.active, .dark .nav-link:hover {
      background: rgba(167,139,250,.12);
      border-color: var(--primary);
    }
    .breadcrumbs { 
      color: var(--muted); 
      font-size: 13px; 
      margin-bottom: 10px; 
      font-weight: 500;
    }

    /* Overlay global */
    .overlay { 
      position: fixed; 
      inset: 0; 
      background: rgba(0,0,0,.25); 
      display: none; 
      align-items: center; 
      justify-content: center; 
      z-index: 1000;
      backdrop-filter: blur(4px);
      transition: all 0.3s ease;
    }
    .dark .overlay {
      background: rgba(0,0,0,.5);
    }
    .overlay.show { display: flex; }
    .spinner { 
      width: 56px; 
      height: 56px; 
      border-radius: 50%; 
      border: 5px solid rgba(255,255,255,.4); 
      border-top-color: #fff; 
      animation: spin 1s linear infinite; 
    }
    .dark .spinner {
      border-color: rgba(167,139,250,.3);
      border-top-color: var(--primary);
    }

    @media (max-width: 900px) { .layout { grid-template-columns:1fr; } .sidebar { order:2; } }

    /* Mejor estilo para bot√≥n de theme toggle */
    .btn-theme-toggle {
      position: relative;
      overflow: hidden;
    }
    
    .btn-theme-toggle::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.1);
      transform: translate(-50%, -50%);
      transition: width 0.6s, height 0.6s;
    }
    
    .btn-theme-toggle:hover::before {
      width: 300px;
      height: 300px;
    }

    .alert-success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }

    .alert-info {
      background: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
    }

    .link {
      color: var(--primary);
      cursor: pointer;
      text-decoration: underline;
      display: inline-block;
      margin-top: 15px;
      transition: all 0.3s ease;
      font-weight: 500;
    }

    .link:hover {
      color: var(--primary-2);
      transform: translateX(2px);
    }

    .panel-actions {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 30px;
    }

    .user-info {
      background: var(--input-bg);
      border: 1px solid var(--border);
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: all 0.3s ease;
    }

    .user-info span {
      font-weight: 600;
      color: var(--text);
    }

    .response-box {
      background: var(--response-bg);
      border: 1px solid var(--response-border);
      border-radius: 8px;
      padding: 20px;
      max-height: 500px;
      overflow-y: auto;
      font-family: 'Courier New', monospace;
      font-size: 14px;
      transition: all 0.3s ease;
      color: var(--text);
    }
    
    .response-box::-webkit-scrollbar {
      width: 8px;
    }
    
    .response-box::-webkit-scrollbar-track {
      background: var(--bg);
      border-radius: 4px;
    }
    
    .response-box::-webkit-scrollbar-thumb {
      background: var(--border);
      border-radius: 4px;
    }
    
    .dark .response-box::-webkit-scrollbar-thumb {
      background: var(--muted);
    }
    
    .response-box::-webkit-scrollbar-thumb:hover {
      background: var(--primary);
    }

    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255,255,255,.3);
      border-radius: 50%;
      border-top-color: #fff;
      animation: spin 1s ease-in-out infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      border-bottom: 2px solid #e0e0e0;
    }

    .tab {
      padding: 10px 20px;
      cursor: pointer;
      border: none;
      background: none;
      font-size: 16px;
      color: #666;
      border-bottom: 3px solid transparent;
      transition: all 0.3s;
    }

    .tab.active {
      color: #667eea;
      border-bottom-color: #667eea;
      font-weight: 600;
    }

    .tab:hover {
      color: #667eea;
    }
  </style>
</head>
<body>

<div id="app" :class="{ dark: isDark }">
  <!-- LOGIN VIEW -->
  <div v-if="currentView === 'login'" class="card">
    <h1>üè• SaluMedX</h1>
    <h2>Iniciar Sesi√≥n</h2>

    <!-- Configuraci√≥n de API URL + Ping -->
    <div class="alert alert-info" style="margin-top:10px;">
      <div style="display:flex; gap:10px; align-items:center; flex-wrap: wrap;">
        <label style="margin:0;">API URL:</label>
        <input v-model="API_URL" style="flex:1; min-width:280px;" placeholder="https://salumedx-rest.onrender.com">
        <button type="button" class="btn btn-secondary" @click="saveApiUrl" :disabled="loading">
          Guardar
        </button>
        <button type="button" class="btn btn-secondary" @click="pingApi" :disabled="loading">
          Probar conexi√≥n
        </button>
      </div>
      <small>‚ö†Ô∏è Tu API usa <strong>cookies de sesi√≥n</strong>. Aseg√∫rate que permita CORS con credentials.</small>
    </div>
    
    <div v-if="error" class="alert alert-error">{{ error }}</div>
    <div v-if="success" class="alert alert-success">{{ success }}</div>
    
    <form @submit.prevent="handleLogin">
      <div class="form-group">
        <label for="username">Usuario:</label>
        <input 
          type="text" 
          id="username" 
          v-model="loginForm.username" 
          placeholder="Ingrese su usuario"
          required
        >
      </div>
      
      <div class="form-group">
        <label for="password">Contrase√±a:</label>
        <input 
          type="password" 
          id="password" 
          v-model="loginForm.password" 
          placeholder="Ingrese su contrase√±a"
          required
        >
      </div>
      
      <button type="submit" class="btn btn-primary" :disabled="loading">
        <span v-if="loading" class="loading"></span>
        <span v-else>Iniciar Sesi√≥n</span>
      </button>
    </form>
    
    <p class="link" @click="currentView = 'register'">
      ¬øNo tienes cuenta? Reg√≠strate aqu√≠
    </p>
  </div>

  <!-- REGISTER VIEW -->
  <div v-if="currentView === 'register'" class="card">
    <h1>üè• SaluMedX</h1>
    <h2>Crear Cuenta</h2>

    <!-- Configuraci√≥n de API URL + Ping -->
    <div class="alert alert-info" style="margin-top:10px;">
      <div style="display:flex; gap:10px; align-items:center; flex-wrap: wrap;">
        <label style="margin:0;">API URL:</label>
        <input v-model="API_URL" style="flex:1; min-width:280px;" placeholder="https://salumedx-rest.onrender.com">
        <button type="button" class="btn btn-secondary" @click="saveApiUrl" :disabled="loading">
          Guardar
        </button>
        <button type="button" class="btn btn-secondary" @click="pingApi" :disabled="loading">
          Probar conexi√≥n
        </button>
      </div>
      <small>‚ö†Ô∏è Tu API usa <strong>cookies de sesi√≥n</strong>. Aseg√∫rate que permita CORS con credentials.</small>
    </div>
    
    <div v-if="error" class="alert alert-error">{{ error }}</div>
    <div v-if="success" class="alert alert-success">{{ success }}</div>
    
    <form @submit.prevent="handleRegister">
      <div class="form-group">
        <label for="reg-username">Usuario:</label>
        <input 
          type="text" 
          id="reg-username" 
          v-model="registerForm.username" 
          placeholder="Elija un nombre de usuario"
          required
        >
      </div>
      
      <div class="form-group">
        <label for="reg-email">Email:</label>
        <input 
          type="email" 
          id="reg-email" 
          v-model="registerForm.email" 
          placeholder="correo@ejemplo.com"
          required
        >
      </div>
      
      <div class="form-group">
        <label for="reg-password">Contrase√±a:</label>
        <input 
          type="password" 
          id="reg-password" 
          v-model="registerForm.password" 
          placeholder="M√≠nimo 8 caracteres"
          required
        >
      </div>
      
      <div class="form-group">
        <label for="reg-password2">Confirmar Contrase√±a:</label>
        <input 
          type="password" 
          id="reg-password2" 
          v-model="registerForm.password2" 
          placeholder="Repita la contrase√±a"
          required
        >
      </div>
      
      <button type="submit" class="btn btn-primary" :disabled="loading">
        <span v-if="loading" class="loading"></span>
        <span v-else>Registrarse</span>
      </button>
    </form>
    
    <p class="link" @click="currentView = 'login'">
      ¬øYa tienes cuenta? Inicia sesi√≥n aqu√≠
    </p>
  </div>

  <!-- PANEL VIEW -->
  <div v-if="currentView === 'panel'" class="layout" role="main" aria-label="Panel principal">
    <aside class="sidebar" aria-label="Navegaci√≥n principal">
      <h3>NAVEGACI√ìN</h3>
      <a href="#" class="nav-link" :class="{active: activeTab==='recetas'}" @click.prevent="activeTab='recetas'">üìã Recetas</a>
      <a href="#" class="nav-link" :class="{active: activeTab==='pdf'}" @click.prevent="activeTab='pdf'">üìÑ Generar PDF</a>
      <a href="#" class="nav-link" :class="{active: activeTab==='precios'}" @click.prevent="activeTab='precios'">üí∞ Precios</a>
      <a href="#" class="nav-link" :class="{active: activeTab==='pacientes'}" @click.prevent="activeTab='pacientes'">üë• Pacientes</a>
      <hr style="margin:14px 0; border-color: var(--border);">
      <button class="btn btn-secondary btn-theme-toggle" style="width:100%; margin-bottom:8px;" @click="toggleDark" :aria-pressed="isDark">
        <span v-if="isDark">‚òÄÔ∏è Modo Claro</span>
        <span v-else>üåô Modo Oscuro</span>
      </button>
      <button class="btn btn-secondary" style="width:100%;" @click="toggleDebug" :aria-pressed="debugMode">{{ debugMode ? 'üîí Ocultar Debug' : 'üîì Mostrar Debug' }}</button>
    </aside>
    <div class="card">
      <h1>üè• SaluMedX</h1>
      <div class="breadcrumbs">Inicio / {{ activeTab }}</div>
      <div class="user-info">
        <div style="display: flex; flex-direction: column; gap: 4px;">
          <span>üë§ Usuario: {{ username }}</span>
          <span v-if="userRole" :style="{ color: isMedico ? 'var(--success)' : 'var(--info)', fontWeight: '500', fontSize: '0.9em' }">
            {{ isMedico ? 'ü©∫ M√©dico' : 'üßë‚Äç‚öïÔ∏è Paciente' }}
          </span>
        </div>
        <div>
          <button @click="testAuth" class="btn btn-secondary" style="margin-right: 10px;" :disabled="loading">üîç Probar Auth</button>
          <button @click="handleLogout" class="btn btn-danger">Cerrar Sesi√≥n</button>
        </div>
      </div>
      <div v-if="error" class="alert alert-error" role="alert">{{ error }}</div>
      <div v-if="success" class="alert alert-success" role="status">{{ success }}</div>
      <div v-if="debugMode" class="alert alert-info" style="margin: 15px 0; padding: 12px;">
        <strong>üîê Debug Auth:</strong><br>
        <small>
          <strong>Token:</strong> {{ authToken ? authToken.substring(0, 25) + '...' : 'SIN TOKEN' }}<br>
          <strong>API:</strong> {{ API_URL }}<br>
          <strong>GraphQL:</strong> {{ GRAPHQL_URL }}
        </small>
      </div>

      <!-- TAB: RECETAS -->
      <div v-if="activeTab === 'recetas'">
        <h2>Mis Recetas</h2>
        <button @click="obtenerRecetas" class="btn btn-primary" :disabled="loading">
          <span v-if="loading" class="loading"></span>
          <span v-else>Cargar Recetas</span>
        </button>
        <div v-if="respuesta" class="response-box" aria-live="polite">
          <pre>{{ JSON.stringify(respuesta, null, 2) }}</pre>
        </div>
      </div>

      <!-- TAB: PDF -->
      <div v-if="activeTab === 'pdf'">
        <h2>Generar Receta PDF</h2>
        
        <!-- Advertencia de permisos - Din√°mica seg√∫n el rol -->
        <div v-if="!isMedico" class="alert-error" style="margin-bottom: 20px; display: flex; align-items: start; gap: 10px;">
          <span style="font-size: 24px;">üö´</span>
          <div>
            <strong>Acceso Restringido - Usuario: PACIENTE</strong><br>
            <small>Tu cuenta est√° registrada como <strong>paciente</strong>. Solo los usuarios con perfil de <strong>m√©dico</strong> pueden generar recetas m√©dicas. 
            Si necesitas una receta, contacta a tu m√©dico tratante.</small>
          </div>
        </div>
        
        <div v-else class="alert-success" style="margin-bottom: 20px; display: flex; align-items: start; gap: 10px;">
          <span style="font-size: 24px;">‚úÖ</span>
          <div>
            <strong>Acceso Autorizado - Usuario: M√âDICO</strong><br>
            <small>Tienes permisos para generar recetas m√©dicas. Completa los datos del paciente y m√©dico para crear el PDF.</small>
          </div>
        </div>

        <div class="form-group">
          <label>Nombre del Paciente:</label>
          <input v-model="pdfForm.paciente.nombre" placeholder="Ej: Cesar" title="Nombre completo del paciente" aria-label="Nombre del Paciente" :disabled="!isMedico">
        </div>
        <div class="form-group">
          <label>C√©dula del Paciente:</label>
          <input v-model="pdfForm.paciente.cedula" placeholder="Ej: 1122334455" title="Documento de identidad del paciente" aria-label="C√©dula del Paciente" :disabled="!isMedico">
        </div>
        <div class="form-group">
          <label>Nombre del M√©dico:</label>
          <input v-model="pdfForm.medico.nombre" placeholder="Ej: Abigail" title="Nombre del m√©dico tratante" aria-label="Nombre del M√©dico" :disabled="!isMedico">
        </div>
        <div class="form-group">
          <label>Licencia del M√©dico:</label>
          <input v-model="pdfForm.medico.licencia" placeholder="Ej: 987654321" title="N√∫mero de licencia profesional" aria-label="Licencia del M√©dico" :disabled="!isMedico">
        </div>
        <button @click="generarPDF" class="btn btn-success" :disabled="loading || !isMedico" aria-busy="loading" :title="!isMedico ? 'Solo m√©dicos pueden generar recetas' : 'Generar receta PDF'">
          <span v-if="loading" class="loading"></span>
          <span v-else-if="!isMedico">üö´ Acceso Restringido</span>
          <span v-else>‚úÖ Generar PDF</span>
        </button>
        <div v-if="respuesta" class="response-box" aria-live="polite">
          <pre>{{ JSON.stringify(respuesta, null, 2) }}</pre>
        </div>
      </div>

      <!-- TAB: PRECIOS -->
      <div v-if="activeTab === 'precios'">
        <h2>Consultar Precios</h2>
        <div class="form-group">
          <label>Nombre del Medicamento:</label>
          <input v-model="preciosForm.nombre" placeholder="Ej: Paracetamol" aria-label="Nombre del medicamento">
        </div>
        <div class="form-group">
          <label>Latitud:</label>
          <input v-model.number="preciosForm.lat" type="number" step="0.000001" placeholder="Ej: -0.21" aria-label="Latitud">
        </div>
        <div class="form-group">
          <label>Longitud:</label>
          <input v-model.number="preciosForm.lng" type="number" step="0.000001" placeholder="Ej: -78.49" aria-label="Longitud">
        </div>
        <div class="form-group">
          <label>Radio (Km):</label>
          <input v-model.number="preciosForm.radioKm" type="number" placeholder="Ej: 5" aria-label="Radio en kil√≥metros">
        </div>
        <button @click="consultarPrecios" class="btn btn-primary" :disabled="loading" aria-busy="loading">
          <span v-if="loading" class="loading"></span>
          <span v-else>Buscar Precios</span>
        </button>
        <div v-if="respuesta" class="response-box" aria-live="polite">
          <pre>{{ JSON.stringify(respuesta, null, 2) }}</pre>
        </div>
      </div>

      <!-- TAB: PACIENTES -->
      <div v-if="activeTab === 'pacientes'">
        <h2>Pacientes Registrados</h2>
        <button @click="obtenerPacientes" class="btn btn-primary" :disabled="loading">
          <span v-if="loading" class="loading"></span>
          <span v-else>Cargar Pacientes</span>
        </button>
        <div v-if="respuesta && respuesta.pacientes" style="margin-top: 20px;">
          <div style="background: var(--input-bg); border: 1px solid var(--border); border-radius: 8px; padding: 20px;">
            <h3 style="margin-bottom: 15px; color: var(--text);">Total: {{ respuesta.pacientes.length }} paciente(s)</h3>
            <div v-for="paciente in respuesta.pacientes" :key="paciente.id" 
                 style="background: var(--card); border: 1px solid var(--border); border-radius: 8px; padding: 15px; margin-bottom: 10px; transition: all 0.3s ease;">
              <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 10px;">
                <div><strong style="color: var(--muted);">ID:</strong> <span style="color: var(--text);">{{ paciente.id }}</span></div>
                <div><strong style="color: var(--muted);">Nombre:</strong> <span style="color: var(--text);">{{ paciente.nombre || 'N/A' }}</span></div>
                <div><strong style="color: var(--muted);">C√©dula:</strong> <span style="color: var(--text);">{{ paciente.cedula || 'N/A' }}</span></div>
                <div><strong style="color: var(--muted);">Email:</strong> <span style="color: var(--text);">{{ paciente.email || 'N/A' }}</span></div>
                <div v-if="paciente.telefono"><strong style="color: var(--muted);">Tel√©fono:</strong> <span style="color: var(--text);">{{ paciente.telefono }}</span></div>
                <div v-if="paciente.fechaNacimiento"><strong style="color: var(--muted);">F. Nacimiento:</strong> <span style="color: var(--text);">{{ paciente.fechaNacimiento }}</span></div>
              </div>
            </div>
          </div>
        </div>
        <div v-else-if="respuesta" class="response-box" aria-live="polite">
          <pre>{{ JSON.stringify(respuesta, null, 2) }}</pre>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="overlay" :class="{ show: loading }" aria-live="assertive" aria-busy="true">
  <div class="spinner" role="progressbar" aria-label="Cargando"></div>
</div>

<script>
const { createApp } = Vue;

createApp({
  data() {
    return {
      currentView: 'login', // 'login', 'register', 'panel'
      activeTab: 'recetas', // 'recetas', 'pdf', 'precios'
      
      // Estado
      loading: false,
      error: null,
      success: null,
  username: '',
  authToken: null, // JWT access token
  refreshToken: null, // JWT refresh token
  userRole: null, // 'medico', 'paciente', 'admin', etc.
  isMedico: false, // Flag para saber si el usuario es m√©dico
      
      // Formularios
      loginForm: {
        username: '',
        password: ''
      },
      
      registerForm: {
        username: '',
        email: '',
        password: '',
        password2: ''
      },
      
      pdfForm: {
        paciente: {
          nombre: 'Cesar',
          cedula: '1122334455'
        },
        medico: {
          nombre: 'Abigail',
          licencia: '987654321'
        },
        detalle: {
          detalleReceta: 1,
          farmacia: 1,
          producto: 1,
          precioEncontrado: 0.30,
          distancia: 3.2,
          fuente: 'P√°gina web de la farmacia'
        }
      },
      
      preciosForm: {
        nombre: 'Paracetamol',
        lat: -0.21,
        lng: -78.49,
        radioKm: 5
      },
      
      respuesta: null,
      
      // URLs - AJUSTAR A TU CONFIGURACI√ìN
      API_URL: 'https://salumedx-rest.onrender.com',
      GRAPHQL_URL: 'http://localhost:4000/graphql',
      isDark: false,
      debugMode: false
    };
  },
  
  mounted() {
    // Cargar URL de API desde localStorage (si existe)
    this.loadApiUrl();
    this.loadAuthToken();
    this.checkAuth();
    const dm = localStorage.getItem('DARK_MODE');
    this.isDark = dm === '1';
  },
  
  methods: {
    clearMessages() {
      this.error = null;
      this.success = null;
    },
    toggleDark(){ this.isDark = !this.isDark; localStorage.setItem('DARK_MODE', this.isDark ? '1' : '0'); },
    toggleDebug(){ this.debugMode = !this.debugMode; },
    
    // ==================== UTILIDADES ====================
    loadApiUrl() {
      const saved = localStorage.getItem('API_URL');
      if (saved) this.API_URL = saved;
    },
    saveApiUrl() {
      localStorage.setItem('API_URL', this.API_URL);
      this.success = 'URL de API guardada.';
    },
    loadAuthToken() {
      const a = localStorage.getItem('AUTH_TOKEN');
      const r = localStorage.getItem('REFRESH_TOKEN');
      if (a) this.authToken = a;
      if (r) this.refreshToken = r;
    },
    saveAuthTokens(access, refresh) {
      this.authToken = access || null;
      this.refreshToken = refresh || null;
      if (access) localStorage.setItem('AUTH_TOKEN', access); else localStorage.removeItem('AUTH_TOKEN');
      if (refresh) localStorage.setItem('REFRESH_TOKEN', refresh); else localStorage.removeItem('REFRESH_TOKEN');
    },
    async pingApi() {
      this.clearMessages();
      this.loading = true;
      try {
        // Intentar con endpoint p√∫blico
        let res = await axios.get(`${this.API_URL}/`, {
          withCredentials: true, // IMPORTANTE: enviar cookies
          validateStatus: () => true,
          timeout: 10000
        });
        
        // Si falla o es 404, probar /signin/
        if (res.status === 404 || res.status >= 500) {
          res = await axios.get(`${this.API_URL}/signin/`, {
            withCredentials: true,
            validateStatus: () => true,
            timeout: 10000
          });
        }
        
        // Cualquier respuesta significa que el servidor est√° vivo
        if (res.status === 403 || res.status === 401) {
          this.success = `‚úÖ API conectada (${res.status}). Requiere autenticaci√≥n con cookies de sesi√≥n.`;
        } else if (res.status === 405) {
          this.success = `‚úÖ API conectada (${res.status} Method Not Allowed). El servidor est√° funcionando.`;
        } else if (res.status < 400) {
          this.success = `‚úÖ API responde correctamente: ${res.status} ${res.statusText}`;
        } else {
          this.success = `‚ö†Ô∏è API responde con: ${res.status} ${res.statusText}`;
        }
      } catch (err) {
        if (err.code === 'ECONNABORTED' || err.message.includes('timeout')) {
          this.error = `‚è±Ô∏è Timeout: La API no respondi√≥ en 10 segundos. Puede estar despertando (Render). Espera 30s e intenta de nuevo.`;
        } else {
          this.error = `‚ùå No se pudo conectar a ${this.API_URL}. ${this.formatAxiosError(err)}`;
        }
      } finally {
        this.loading = false;
      }
    },
    formatAxiosError(error) {
      try {
        const status = error.response?.status;
        const statusText = error.response?.statusText;
        const code = error.code;
        const msg = error.message;
        const url = error.config?.url;
        return `Detalle: status=${status ?? 'N/A'} ${statusText ?? ''} code=${code ?? 'N/A'} url=${url ?? ''} msg=${msg ?? ''}`;
      } catch (_) {
        return String(error);
      }
    },
    
    // ==================== AUTENTICACI√ìN (JWT) ====================
    async checkAuth() {
      if (!this.authToken) return;
      try {
        const res = await axios.get(`${this.API_URL}/tasks/`, {
          headers: { 'Authorization': `Bearer ${this.authToken}` },
          validateStatus: () => true
        });
        if (res.status < 400) {
          this.currentView = 'panel';
        } else if ([401,403].includes(res.status)) {
          console.warn(`‚ö†Ô∏è Token inv√°lido (${res.status}). Limpiando sesi√≥n.`);
          this.saveAuthTokens(null, null);
        }
      } catch (e) {
        console.log('Error verificando autenticaci√≥n:', this.formatAxiosError(e));
      }
    },
    
    async verificarRolUsuario() {
      console.log('üîç Verificando rol del usuario...');
      try {
        if (!this.authToken) {
          console.warn('No hay token para verificar rol');
          return;
        }

        // Intentar obtener perfil del usuario
        const endpoints = ['/me/', '/api/user/', '/user/profile/'];
        
        for (const endpoint of endpoints) {
          try {
            const res = await axios.get(`${this.API_URL}${endpoint}`, {
              headers: { 'Authorization': `Bearer ${this.authToken}` },
              validateStatus: () => true,
              timeout: 5000
            });
            
            if (res.status === 200 && res.data) {
              console.log('‚úÖ Perfil obtenido:', res.data);
              
              // Detectar si es m√©dico
              this.isMedico = res.data.is_medico || 
                             res.data.is_doctor || 
                             res.data.role === 'medico' ||
                             res.data.role === 'doctor' ||
                             res.data.user_type === 'medico' ||
                             !!res.data.licencia_medica;
              
              this.userRole = res.data.role || res.data.user_type || (this.isMedico ? 'medico' : 'paciente');
              
              console.log(`üë§ Rol detectado: ${this.userRole} | Es m√©dico: ${this.isMedico}`);
              
              if (this.isMedico) {
                this.success = 'ü©∫ Sesi√≥n iniciada como M√âDICO - Puedes generar recetas';
              } else {
                this.success = 'üë§ Sesi√≥n iniciada como PACIENTE - Consulta recetas y precios';
              }
              
              return;
            }
          } catch (e) {
            console.log(`‚ö†Ô∏è No se pudo obtener perfil desde ${endpoint}`);
          }
        }
        
        // Si no hay endpoint de perfil, intentar buscar en listas de m√©dicos y pacientes
        console.log('üîç Intentando verificar mediante b√∫squeda en listas...');
        
        // Primero buscar si est√° en lista de pacientes
        try {
          const pacienteRes = await axios.get(`${this.API_URL}/paciente-info/`, {
            headers: { 'Authorization': `Bearer ${this.authToken}` },
            validateStatus: () => true,
            timeout: 5000
          });
          
          if (pacienteRes.status === 200 && pacienteRes.data) {
            const data = pacienteRes.data;
            const pacientes = Array.isArray(data) ? data : (data.pacientes || data.results || []);
            
            // Buscar si el usuario actual est√° en la lista de pacientes
            const isPaciente = pacientes.some(p => 
              p.username?.toLowerCase() === this.username?.toLowerCase() ||
              p.nombre?.toLowerCase().includes(this.username?.toLowerCase())
            );
            
            if (isPaciente) {
              console.log('‚úÖ Usuario encontrado en lista de PACIENTES');
              this.isMedico = false;
              this.userRole = 'paciente';
              this.success = 'üë§ Sesi√≥n iniciada como PACIENTE - Consulta recetas y precios';
              return;
            }
          }
        } catch (e) {
          console.log('‚ö†Ô∏è No se pudo verificar lista de pacientes');
        }
        
        // Si no est√° en pacientes, buscar en m√©dicos
        try {
          const medicoRes = await axios.get(`${this.API_URL}/medico-info/`, {
            headers: { 'Authorization': `Bearer ${this.authToken}` },
            validateStatus: () => true,
            timeout: 5000
          });
          
          if (medicoRes.status === 200 && medicoRes.data) {
            const data = medicoRes.data;
            const medicos = Array.isArray(data) ? data : (data.medicos || data.results || []);
            
            // Buscar si el usuario actual est√° en la lista de m√©dicos
            const isMedico = medicos.some(m => 
              m.username?.toLowerCase() === this.username?.toLowerCase() ||
              m.nombre?.toLowerCase().includes(this.username?.toLowerCase())
            );
            
            if (isMedico) {
              console.log('‚úÖ Usuario encontrado en lista de M√âDICOS');
              this.isMedico = true;
              this.userRole = 'medico';
              this.success = 'ü©∫ Sesi√≥n iniciada como M√âDICO - Puedes generar recetas';
              return;
            }
          }
        } catch (e) {
          console.log('‚ö†Ô∏è No se pudo verificar lista de m√©dicos');
        }
        
        // Por defecto, asumimos que es paciente (m√°s seguro)
        console.log('‚ö†Ô∏è No se encontr√≥ en ninguna lista, asumiendo PACIENTE por seguridad');
        this.isMedico = false;
        this.userRole = 'paciente';
        
      } catch (error) {
        console.error('‚ùå Error verificando rol:', error);
        // Por seguridad, si hay error, asumimos que NO es m√©dico
        this.isMedico = false;
        this.userRole = 'paciente';
      }
    },
    
    async testAuth() {
      this.clearMessages();
      this.loading = true;
      try {
        if (!this.authToken) {
          this.error = 'No hay token cargado. Inicia sesi√≥n primero.';
          return;
        }
        const endpoints = ['/tasks/', '/recetas/', '/farmacias/'];
        for (const endpoint of endpoints) {
          const res = await axios.get(`${this.API_URL}${endpoint}`, {
            headers: { 'Authorization': `Bearer ${this.authToken}` },
            validateStatus: () => true,
            timeout: 10000
          });
          console.log(`‚Üí ${endpoint}: ${res.status}`);
          if (res.status === 200) {
            this.success = `‚úÖ ${endpoint} OK (200)`;
            this.currentView = 'panel';
            return;
          } else if ([401,403].includes(res.status)) {
            this.error = `Auth fallo en ${endpoint}: ${res.status}. Token inv√°lido o expirado.`;
            return;
          }
        }
        this.error = 'Ning√∫n endpoint respondi√≥ 200.';
      } catch (e) {
        this.error = 'Error de red: ' + this.formatAxiosError(e);
      } finally {
        this.loading = false;
      }
    },
    
    async handleLogin() {
      this.clearMessages();
      this.loading = true;
      
      try {
        // Enviar credenciales al login
        const payload = {
          username: this.loginForm.username,
          email: this.loginForm.username,
          password: this.loginForm.password,
        };
        
        console.log('üì§ Intentando login en:', `${this.API_URL}/signin/`);
        const response = await axios.post(
          `${this.API_URL}/signin/`,
          payload,
          {
            headers: { 'Content-Type': 'application/json' },
            validateStatus: () => true
          }
        );
        
        console.log('üì• Respuesta login:', response.status, response.statusText);
        console.log('üì• Data:', response.data);
        console.log('üì• Headers:', response.headers);
        
        if (response.status >= 400) {
          // Mostrar el error exacto que devuelve la API
          const errorDetail = response.data?.detail || response.data?.message || response.data?.error;
          if (errorDetail) {
            throw new Error(`Error ${response.status}: ${errorDetail}`);
          } else {
            throw new Error(`Error ${response.status}: ${JSON.stringify(response.data)}`);
          }
        }
        // Extraer tokens JWT
        const access = response.data?.access;
        const refresh = response.data?.refresh;
        if (!access) {
          console.warn('‚ö†Ô∏è No se recibi√≥ token de acceso en la respuesta');
        } else {
          this.saveAuthTokens(access, refresh);
        }
        
        console.log('‚úÖ Login exitoso');
        this.success = '¬°Login exitoso!';
        this.username = this.loginForm.username;
        
        // üîç Verificar el rol del usuario despu√©s del login
        await this.verificarRolUsuario();
        
        this.currentView = 'panel';
        this.loginForm.password = '';
        
      } catch (error) {
        console.error('‚ùå Error en login:', error);
        console.error('‚ùå Response:', error.response?.data);
        this.error = error.message || 'Error al iniciar sesi√≥n. Verifica tus credenciales y que la API est√© disponible.';
      } finally {
        this.loading = false;
      }
    },
    
    async handleRegister() {
      this.clearMessages();
      
      // Validaciones
      if (this.registerForm.password !== this.registerForm.password2) {
        this.error = 'Las contrase√±as no coinciden';
        return;
      }
      
      if (this.registerForm.password.length < 8) {
        this.error = 'La contrase√±a debe tener al menos 8 caracteres';
        return;
      }
      
      this.loading = true;
      
      try {
        const headers = { 'Content-Type': 'application/json' };
        
        const response = await axios.post(
          `${this.API_URL}/signup/`,
          {
            username: this.registerForm.username,
            email: this.registerForm.email,
            password: this.registerForm.password
          },
          {
            headers,
            validateStatus: () => true
          }
        );
        
        if (response.status >= 400) {
          throw new Error(response.data?.detail || response.data?.message || 'No se pudo registrar');
        }
        
        this.success = '¬°Registro exitoso! Redirigiendo al login...';
        
        setTimeout(() => {
          this.currentView = 'login';
          this.loginForm.username = this.registerForm.username;
          this.registerForm = { username: '', email: '', password: '', password2: '' };
        }, 2000);
        
      } catch (error) {
        console.error('Error en registro:', this.formatAxiosError(error));
        this.error = error.response?.data?.detail || error.response?.data?.message || error.message || 'Error al registrarse';
      } finally {
        this.loading = false;
      }
    },
    
    async handleLogout() {
      try {
        // Opcional: llamar endpoint de logout si existe (no requiere cookies)
        await axios.post(`${this.API_URL}/logout/`, {}, { validateStatus: () => true });
        this.currentView = 'login';
        this.username = '';
        this.userRole = null;
        this.isMedico = false;
        this.saveAuthTokens(null, null);
        this.success = 'Sesi√≥n cerrada correctamente';
        
        console.log('‚úÖ Logout exitoso - Tokens eliminados');
        
      } catch (error) {
        console.error('Error en logout:', error);
        // Igualmente cerrar sesi√≥n localmente
        this.currentView = 'login';
        this.username = '';
        this.userRole = null;
        this.isMedico = false;
        this.saveAuthTokens(null, null);
      }
    },
    
    // ==================== GRAPHQL ====================
    
    async graphql(query, variables = {}) {
      try {
        const headers = {
          'Content-Type': 'application/json'
        };
        if (this.authToken) {
          headers['Authorization'] = `Bearer ${this.authToken}`;
        }
        
        const response = await axios.post(
          this.GRAPHQL_URL,
          {
            query,
            variables
          },
          {
            headers,
            validateStatus: () => true
          }
        );
        
        // Verificar si hay error 403 en respuesta GraphQL
        if (response.data?.errors) {
          const has403 = response.data.errors.some(e => 
            e.message.includes('403') || 
            e.message.includes('autorizado') || 
            e.message.includes('autenticado')
          );
          
          if (has403) {
            console.error('üîí Error 403 detectado:', response.data.errors);
            console.error('Auth Token presente:', !!this.authToken);
            console.error('API URL:', this.API_URL);
            
            // Sugerencia de diagn√≥stico
            const suggestions = [
              '1. Verifica que el token no haya expirado',
              '2. Inicia sesi√≥n nuevamente para refrescar el token',
              '3. Asegura que Authorization: Bearer se est√© enviando',
              '4. Verifica que la API REST est√© funcionando: ' + this.API_URL,
              '5. Si hay refresh token implementa flujo de refresco'
            ];
            console.warn('üí° Sugerencias:', suggestions.join('\n'));
          }
        }
        
        return response.data;
        
      } catch (error) {
        console.error('Error en GraphQL:', this.formatAxiosError(error));
        throw error;
      }
    },
    
    // ==================== OPERACIONES ====================
    
    async obtenerRecetas() {
      this.clearMessages();
      this.loading = true;
      this.respuesta = null;
      
      try {
        const query = `
          query {
            recetas {
              id
              fechaEmision
              pacienteId
              medicoId
              observaciones
              detalles {
                id
                productoId
                cantidad
                indicaciones
              }
            }
          }
        `;
        
        const result = await this.graphql(query);
        
        if (result.errors) {
          this.error = result.errors[0].message;
        } else {
          this.respuesta = result.data;
          this.success = 'Recetas cargadas correctamente';
        }
        
      } catch (error) {
        this.error = 'Error al obtener recetas: ' + error.message;
      } finally {
        this.loading = false;
      }
    },
    
    async generarPDF() {
      this.clearMessages();
      this.loading = true;
      this.respuesta = null;
      try {
        const query = `
          mutation($pac: PacienteInput!, $med: MedicoInput!) {
            generarRecetaPdf(paciente: $pac, medico: $med) {
              mensaje
              archivo
            }
          }
        `;
        const variables = {
          pac: this.pdfForm.paciente,
          med: this.pdfForm.medico
        };
        const result = await this.graphql(query, variables);
        if (result.errors) {
          const errorMsg = result.errors[0].message;
          
          // Detectar si el error es de permisos de m√©dico
          if (errorMsg.includes('Solo un m√©dico') || 
              errorMsg.includes('Acceso denegado') || 
              errorMsg.includes('m√©dico puede generar')) {
            this.error = 'ü©∫ ' + errorMsg;
            
            // Mostrar mensaje adicional si es paciente
            setTimeout(() => {
              if (this.error) {
                this.error += '\n\nüí° Consejo: Si eres paciente, solicita a tu m√©dico que genere la receta por ti.';
              }
            }, 100);
          } else {
            this.error = errorMsg;
          }
        } else {
          this.respuesta = result.data;
          this.success = 'PDF generado correctamente';
          
          // Auto-abrir PDF en nueva pesta√±a si se gener√≥ correctamente
          if (result.data.generarRecetaPdf && result.data.generarRecetaPdf.archivo) {
            const base = this.GRAPHQL_URL.replace('/graphql', '');
            const url = base + result.data.generarRecetaPdf.archivo;
            window.open(url, '_blank');
          }
        }
      } catch (error) {
        this.error = 'Error al generar PDF: ' + error.message;
      } finally {
        this.loading = false;
      }
    },
    
    async consultarPrecios() {
      this.clearMessages();
      this.loading = true;
      this.respuesta = null;
      
      try {
        const query = `
          query($nombre: String!, $lat: Float!, $lng: Float!, $radioKm: Float!) {
            preciosMasBaratos(nombre: $nombre, lat: $lat, lng: $lng, radioKm: $radioKm) {
              farmaciaNombre
              precio
              distanciaKm
            }
          }
        `;
        
        const variables = this.preciosForm;
        
        const result = await this.graphql(query, variables);
        
        if (result.errors) {
          this.error = result.errors[0].message;
        } else {
          this.respuesta = result.data;
          this.success = 'Precios consultados correctamente';
        }
        
      } catch (error) {
        this.error = 'Error al consultar precios: ' + error.message;
      } finally {
        this.loading = false;
      }
    },
    
    async obtenerPacientes() {
      this.clearMessages();
      this.loading = true;
      this.respuesta = null;
      
      try {
        const query = `
          query {
            pacientes {
              id
              nombre
              cedula
              email
              telefono
              direccion
              fechaNacimiento
              usuarioId
            }
          }
        `;
        
        const result = await this.graphql(query);
        
        if (result.errors) {
          this.error = result.errors[0].message;
        } else {
          this.respuesta = result.data;
          this.success = `${result.data.pacientes.length} paciente(s) encontrado(s)`;
        }
        
      } catch (error) {
        this.error = 'Error al obtener pacientes: ' + error.message;
      } finally {
        this.loading = false;
      }
    }
  }
}).mount('#app');
</script>

</body>
</html>
